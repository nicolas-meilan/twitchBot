<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Events</title>
  <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>
  <script>
    const WEBSOCKET_URL = "__WEBSOCKET_URL__";
    const OBS_VIEWS_WS_URL = "__OBS_VIEWS_WS_URL__";
    const OBS_CLIPS_FONT_NAME = "__OBS_CLIPS_FONT_NAME__";
    const PASSWORD = "__PASSWORD__";

    const DEFAULT_CLIP_TIME = 30000;
    const CLIP_PLUS_TIME = 2100;

    let ws;
    let obs;
    let voices = [];

    window.speechSynthesis.onvoiceschanged = () => {
      voices = window.speechSynthesis.getVoices();
    };

    async function connectObs() {
      obs = new OBSWebSocket();
      try {
        await obs.connect(OBS_VIEWS_WS_URL, PASSWORD);
      } catch (error) {
        console.error('Error connecting OBS websocket', error);
      }
    }

    function connectBotWebSocket() {
      ws = new WebSocket(WEBSOCKET_URL);
      ws.onopen = function () {
        ws.send(PASSWORD);
      };
      ws.onmessage = async function (event) {
        const data = JSON.parse(event.data);
        const { type } = data;
        if (type === "TTS" && data.message) {
          const utterance = new SpeechSynthesisUtterance(data.message);
          utterance.voice = voices.find(voice => voice.name.includes("Sabina")) || voices[0];
          window.speechSynthesis.speak(utterance);
          return;
        }
        if (type === "CLIP" && data.url) {
          if (!obs) return;

          try {
            const url = `${data.url}&parent=localhost&autoplay=true&controls=false`;
            await obs.call('SetInputSettings', {
              inputName: OBS_CLIPS_FONT_NAME,
              inputSettings: {
                url,
                is_local_file: false,
              }
            });

            const videoTimeMs = (Number(data.duration || '0') * 1000) || DEFAULT_CLIP_TIME;
            setTimeout(async () => {
              await obs.call('SetInputSettings', {
              inputName: OBS_CLIPS_FONT_NAME,
              inputSettings: {
                url: '',
                is_local_file: false,
              }
            });
            }, videoTimeMs + CLIP_PLUS_TIME);
          } catch (error) {
            console.error('Error changing obs font', error);
          }
          return;
        }
      };
      ws.onclose = function () { };
      ws.onerror = function (error) {
        console.error('Error connecting bot websocket', error);
      };
    }

    window.onload = function () {
      connectObs();
      connectBotWebSocket();
    };
  </script>
</head>

<body></body>

</html>